<!DOCTYPE html>
<html class="light" lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>은퇴 시뮬레이터 (동적 포트폴리오)</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap" rel="stylesheet"/>

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="presets.js"></script>
  <script src="events.js"></script>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#2563eb",
            "secondary": "#1e40af",
            "background-light": "#f8fafc",
            "background-dark": "#0f172a",
          },
          fontFamily: { "display": ["Manrope", "sans-serif"] },
          borderRadius: {
            "DEFAULT": "0.375rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>

  <style type="text/tailwindcss">
    @layer base { body { font-family: 'Manrope', sans-serif; } }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #2563eb; }
    .table-scroll-area { max-height: 700px; overflow-y: auto; }
    .row-chevron { transition: transform .15s ease; }
    .row-open .row-chevron { transform: rotate(90deg); }
    dialog::backdrop { background: rgba(0,0,0,.35); }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen font-display">
<main class="max-w-[1440px] mx-auto px-6 lg:px-10 py-10">

  <!-- Header -->
  <div class="mb-8 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100">
        은퇴 <span class="text-primary">시뮬레이터</span>
      </h1>
      <p class="text-slate-500 text-sm mt-1">동적 포트폴리오 • 이벤트 기반 • 영구 저장</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-right hidden sm:block">
        <p class="text-xs font-bold text-slate-900 dark:text-slate-100 leading-none">로컬 프로필</p>
        <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">브라우저에 저장됨</p>
      </div>
      <div class="size-10 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-primary/20 flex items-center justify-center">
        <span class="material-symbols-outlined text-slate-500 dark:text-slate-200">person</span>
      </div>
    </div>
  </div>

  <div class="flex flex-col lg:flex-row gap-8">

    <!-- Left -->
    <aside class="w-full lg:w-[440px] flex flex-col gap-6">

      <!-- Config -->
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">tune</span>
            기본 설정
          </h2>
          <button id="btnResetAll" class="px-3 py-2 rounded-lg text-xs font-bold bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-200 hover:bg-red-100 dark:hover:bg-red-900/30">
            저장된 데이터 초기화
          </button>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">현재 나이</label>
              <input id="ageNow" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"
                     type="number" min="0" max="120" value="30"/>
            </div>
            <div class="space-y-1.5">
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">은퇴 연령</label>
              <input id="ageRetire" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"
                     type="number" min="0" max="120" value="65"/>
            </div>
          </div>

          <div class="space-y-1.5">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">초기 투자액 (₩)</label>
            <input id="initialInvestment" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"
                   type="text" value="50,000"/>
          </div>

          <div class="space-y-1.5">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">월 납입액 (₩)</label>
            <input id="monthlyContribution" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"
                   type="text" value="2,000"/>
          </div>

          <!-- Retirement auto switch -->
          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-3">
            <div>
              <p class="text-xs font-bold">은퇴 후 납입액 자동 0으로 설정</p>
              <p class="text-[11px] text-slate-500 dark:text-slate-400">은퇴 연령부터 월 납입액이 0이 됩니다</p>
            </div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="autoZeroAfterRetire" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-600 peer-checked:bg-primary relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Events -->
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">event_note</span>
            시나리오 이벤트
          </h2>
          <button id="btnAddEvent" class="flex items-center gap-1 text-[11px] font-bold uppercase tracking-wider text-primary hover:text-primary/80 transition-colors">
            <span class="material-symbols-outlined text-sm">add_circle</span> 이벤트 추가
          </button>
        </div>

        <div id="eventList" class="space-y-3"></div>

        <div class="mt-4 text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed">
          지원 항목: <span class="font-semibold">포트폴리오 변경</span>,
          <span class="font-semibold">월 납입액 변경</span>, <span class="font-semibold">일시불</span>,
          <span class="font-semibold">연금(월 지급)</span>.
        </div>
         <button id="btnAddPreset" class="mt-4 w-full flex items-center justify-center gap-1 text-xs font-bold uppercase tracking-wider text-primary hover:text-primary/80 transition-colors border border-primary/50 rounded-lg py-2">
            <span class="material-symbols-outlined text-sm">add_circle</span> 투자 프리셋 관리
          </button>
      </div>

      <!-- Filter -->
      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">filter_alt</span>
          표 필터 (나이 범위)
        </h2>

        <div class="grid grid-cols-2 gap-3">
          <label class="block">
            <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">시작 나이</span>
            <input id="filterAgeFrom" type="number" min="0" max="120"
                   class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"
                   value="30"/>
          </label>
          <label class="block">
            <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">종료 나이</span>
            <input id="filterAgeTo" type="number" min="0" max="120"
                   class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"
                   value="100"/>
          </label>
        </div>

        <div class="mt-3 flex items-center justify-between bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-3">
          <div>
            <p class="text-xs font-bold">필터 활성화</p>
            <p class="text-[11px] text-slate-500 dark:text-slate-400">선택한 나이 범위의 연도만 표시</p>
          </div>
          <label class="inline-flex items-center cursor-pointer">
            <input id="filterEnabled" type="checkbox" class="sr-only peer">
              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-600 peer-checked:bg-primary relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>
            </label>
        </div>
      </div>

    </aside>

    <!-- Right -->
    <section class="flex-1 flex flex-col gap-6">

      <!-- Table Card -->
      <div class="bg-white dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col h-full overflow-hidden">
        <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-900 z-10">
          <div>
            <h2 class="text-lg font-bold">연간 성장 예측</h2>
            <p id="rangeLabel" class="text-xs text-slate-500 mt-0.5">예상 분석</p>
          </div>
          <div class="flex gap-2 items-center">
            <button id="btnToggleChart" class="size-10 flex items-center justify-center bg-primary text-white rounded-lg shadow-lg shadow-primary/20 hover:bg-secondary transition-all hover:scale-105 active:scale-95 group" title="차트 보기">
              <span class="material-symbols-outlined">bar_chart</span>
            </button>
          </div>
        </div>

        <!-- Chart Panel -->
        <div id="chartPanel" class="hidden border-b border-slate-100 dark:border-slate-800 bg-slate-50/60 dark:bg-slate-900/40 p-4">
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-bold uppercase tracking-wider text-slate-500">자산 구성</p>
            <p class="text-[11px] text-slate-500 dark:text-slate-400">연도별 누적 투자원금 및 투자수익</p>
          </div>
          <div class="bg-white dark:bg-slate-950 rounded-xl border border-slate-200 dark:border-slate-800 p-3">
            <canvas id="balanceChart" height="360"></canvas>
          </div>
        </div>

        <div class="table-scroll-area custom-scrollbar overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="sticky top-0 bg-slate-50 dark:bg-slate-800 z-10 shadow-sm">
              <tr class="text-slate-500 font-bold uppercase text-[11px] tracking-wider">
                <th class="px-6 py-4">연도 / 나이</th>
                <th class="px-6 py-4">연간 납입액</th>
                <th class="px-6 py-4">평가 수익</th>
                <th class="px-6 py-4">배당금</th>
                <th class="px-6 py-4">연금 인출</th>
                <th class="px-6 py-4">기말 잔액</th>
                <th class="px-6 py-4">포트폴리오</th>
              </tr>
            </thead>
            <tbody id="annualTbody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
          </table>
        </div>
      </div>

      <!-- Observation -->
      <div class="bg-primary/5 border border-primary/20 p-5 rounded-xl flex items-start gap-4">
        <div class="bg-primary text-white p-2.5 rounded-lg shadow-sm">
          <span class="material-symbols-outlined block">lightbulb</span>
        </div>
        <div>
          <h4 class="text-sm font-bold text-slate-900 dark:text-white">스마트 요약</h4>
          <p id="observation" class="text-xs text-slate-600 dark:text-slate-400 mt-1 leading-relaxed">
            왼쪽 항목들을 수정하여 은퇴 계획을 시뮬레이션 해보세요.
          </p>
        </div>
      </div>

    </section>
  </div>
</main>

<footer class="mt-12 py-10 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950">
  <div class="max-w-[1440px] mx-auto px-10 flex flex-col md:flex-row items-center justify-between gap-6 text-slate-500 text-[11px] font-medium">
    <div class="flex items-center gap-4">
      <span class="material-symbols-outlined text-primary text-sm">verified_user</span>
      <p>© 2024 은퇴계획 Pro. 데이터는 브라우저에 저장됩니다. 본 시뮬레이션은 투자 자문이 아닙니다.</p>
    </div>
  </div>
</footer>

<!-- Add Event Dialog -->
<dialog id="eventDialog" class="rounded-xl p-0 w-[92vw] max-w-md bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 shadow-2xl">
  <form method="dialog" class="p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-sm font-extrabold">시나리오 이벤트 추가</h3>
      <button value="cancel" class="text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">나이</span>
          <input id="dlgAge" type="number" min="0" max="120"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">종류</span>
          <select id="dlgType" class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold">
            <option value="portfolio">포트폴리오 변경</option>
            <option value="monthly">월 납입액 변경</option>
            <option value="lump">일시불 입금</option>
            <option value="pension">연금 수령 (월)</option>
          </select>
        </label>
      </div>

      <div id="dlgFieldsPortfolio" class="space-y-3 pt-2">
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">투자 프리셋</span>
          <select id="dlgPresetId" class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"></select>
        </label>
         <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">비중 (1-10)</span>
          <input id="dlgWeight" type="number" min="1" max="10" value="10"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
      </div>

      <div id="dlgFieldsMonetary" class="hidden space-y-3 pt-2">
         <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">라벨</span>
          <input id="dlgLabel" type="text" placeholder="예: 승진, 아파트 매매"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">금액 (₩)</span>
          <input id="dlgAmount" type="text" placeholder="예: 1500000"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
      </div>

      <div id="dlgInfo" class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed pt-1"></div>
    </div>

    <div class="mt-5 flex gap-2 justify-end">
      <button value="cancel" class="px-4 py-2 rounded-lg text-xs font-bold bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700">취소</button>
      <button id="dlgSave" value="ok" class="px-4 py-2 rounded-lg text-xs font-bold bg-primary text-white hover:bg-secondary">이벤트 추가</button>
    </div>
  </form>
</dialog>

<!-- Add Preset Dialog -->
<dialog id="presetDialog" class="rounded-xl p-0 w-[92vw] max-w-md bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 shadow-2xl">
  <div class="p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-extrabold">투자 프리셋 관리</h3>
       <form method="dialog">
        <button value="cancel" class="text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">
          <span class="material-symbols-outlined">close</span>
        </button>
      </form>
    </div>
    
    <div id="presetList" class="space-y-2 mb-4"></div>

    <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 pt-4 border-t border-slate-200 dark:border-slate-800">새 프리셋 추가</h4>
    <form id="newPresetForm" class="space-y-3">
      <label class="block">
        <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">프리셋 이름</span>
        <input id="dlgPresetName" type="text" placeholder="예: 성장주 포트폴리오"
               class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
      </label>

      <div class="grid grid-cols-2 gap-3">
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">연간 수익률 (%)</span>
          <input id="dlgPresetReturn" type="text" value="9.0"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
        <label class="block">
          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">배당 수익률 (%)</span>
          <input id="dlgPresetDiv" type="text" value="2.0"
                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>
        </label>
      </div>
      <button id="dlgPresetSave" type="submit" class="w-full px-4 py-2 rounded-lg text-xs font-bold bg-primary text-white hover:bg-secondary">새 프리셋 저장</button>
    </form>
  </div>
</dialog>

<script>
/** =============================
 *  Persistence (localStorage)
 *  ============================= */
const STORAGE_KEY = "retire_sim_v2_dynamic_portfolio";

function safeJsonParse(s) {
  try { return JSON.parse(s); } catch { return null; }
}

function loadSavedState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  const data = safeJsonParse(raw);
  return data && typeof data === "object" ? data : null;
}

function saveStateDebounced() {
  clearTimeout(saveStateDebounced._t);
  saveStateDebounced._t = setTimeout(() => {
    const snapshot = buildSnapshot();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));
  }, 150);
}

function resetSavedState() {
  localStorage.removeItem(STORAGE_KEY);
}

/** -----------------------------
 *  Utilities
 *  ----------------------------- */
const $ = (id) => document.getElementById(id);

function parseMoney(input) {
  if (typeof input === "number") return input;
  const s = String(input || "").replace(/[^0-9.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function fmtMoney(n, compact = false) {
    const num = Number(n);
    if (!Number.isFinite(num)) return "0원";

    if (compact) {
        if (Math.abs(num) >= 100000000) {
            return `${parseFloat((num / 100000000).toFixed(2))}억`;
        } else if (Math.abs(num) >= 10000) {
            return `${parseFloat((num / 10000).toFixed(0))}만`;
        }
    }
    return `${Math.round(num).toLocaleString()}원`;
}

function clamp(n, min, max) {
  return Math.max(min, Math.min(max, n));
}

function parsePct(s) {
  const v = Number(parseFloat(String(s || "").replace(/[^0-9.%]/g, "")));
  return Number.isFinite(v) ? v : 0;
}

function uid() {
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
}

/** =============================
 *  State
 *  ============================= */
const state = {
  startYear: new Date().getFullYear(),
  maxAge: 100,

  presets: [...defaultPresets],

  inputs: {
    ageNow: 30,
    ageRetire: 65,
    initialInvestment: 50000000,
    monthlyContribution: 2000000,
    autoZeroAfterRetire: true,
    filterEnabled: false,
    filterAgeFrom: 30,
    filterAgeTo: 100
  },

  events: [],
  results: null,
  chart: null
};

/** =============================
 *  Snapshot / Restore
 *  ============================= */
function buildSnapshot() {
  return {
    version: 2,
    presets: state.presets.map(p => ({ ...p })),
    inputs: { ...state.inputs },
    events: state.events.map(e => ({ ...e })),
    savedAt: new Date().toISOString()
  };
}

function applySnapshot(snap) {
  if (!snap || snap.version !== 2) {
    state.events = defaultEvents.map(e => ({ ...e, id: uid() }));
    return;
  }

  // Presets
  const builtins = [...defaultPresets];
  const userPresets = Array.isArray(snap.presets)
    ? snap.presets.filter(p => p && !p.builtin && p.id && p.name)
    : [];
  state.presets = [...builtins, ...userPresets];

  // Inputs
  if (snap.inputs && typeof snap.inputs === 'object') {
     Object.assign(state.inputs, snap.inputs);
  }

  // Events
  if (Array.isArray(snap.events) && snap.events.length > 0) {
    state.events = snap.events
      .filter(e => e && e.type && e.age != null)
      .map(e => ({ ...e, id: e.id || uid() }));
  } else {
    state.events = defaultEvents.map(e => ({ ...e, id: uid() }));
  }
}

/** =============================
 *  UI binding helpers
 *  ============================= */
function syncStateToUi() {
  $("ageNow").value = state.inputs.ageNow;
  $("ageRetire").value = state.inputs.ageRetire;
  $("initialInvestment").value = state.inputs.initialInvestment.toLocaleString();
  $("monthlyContribution").value = state.inputs.monthlyContribution.toLocaleString();
  $("autoZeroAfterRetire").checked = state.inputs.autoZeroAfterRetire;

  $("filterEnabled").checked = state.inputs.filterEnabled;
  $("filterAgeFrom").value = state.inputs.filterAgeFrom;
  $("filterAgeTo").value = state.inputs.filterAgeTo;

  renderEventList();
}

function syncUiToStateFromInputs() {
  state.inputs.ageNow = clamp(Number($("ageNow").value || 0), 0, 120);
  state.inputs.ageRetire = clamp(Number($("ageRetire").value || 0), 0, 120);
  state.inputs.initialInvestment = parseMoney($("initialInvestment").value);
  state.inputs.monthlyContribution = parseMoney($("monthlyContribution").value);
  state.inputs.autoZeroAfterRetire = $("autoZeroAfterRetire").checked;

  state.inputs.filterEnabled = $("filterEnabled").checked;
  state.inputs.filterAgeFrom = clamp(Number($("filterAgeFrom").value || 0), 0, 120);
  state.inputs.filterAgeTo = clamp(Number($("filterAgeTo").value || 0), 0, 120);
}


/** =============================
 *  Presets Management
 *  ============================= */
function renderPresetList() {
  const listEl = $("presetList");
  listEl.innerHTML = "";
  state.presets.forEach(p => {
    const item = document.createElement("div");
    item.className = "flex items-center justify-between gap-2 text-sm p-2 rounded-lg bg-slate-50 dark:bg-slate-800/50";
    item.innerHTML = `
      <div class="font-bold">${p.name} ${p.builtin ? '(기본)' : ''}</div>
      <div class="text-xs text-slate-500">수익 ${p.annualReturnPct}% / 배당 ${p.dividendPct}%</div>
      ${!p.builtin ? `<button data-del-preset="${p.id}" class="text-red-500 hover:text-red-400"><span class="material-symbols-outlined text-sm">delete</span></button>` : ''}
    `;
    listEl.appendChild(item);
  });

  listEl.querySelectorAll("[data-del-preset]").forEach(btn => {
      btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-del-preset");
          state.presets = state.presets.filter(p => p.id !== id);
          renderPresetList();
          recalcAndRender();
          saveStateDebounced();
      });
  });
}

function initPresetManagement() {
    const dlg = $('presetDialog');
    $('btnAddPreset').addEventListener('click', () => {
        renderPresetList();
        $('newPresetForm').reset();
        dlg.showModal();
    });

    $('newPresetForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = ($("dlgPresetName").value || "").trim();
        const r = parsePct($("dlgPresetReturn").value);
        const d = parsePct($("dlgPresetDiv").value);

        if (!name) return;
        const id = "u_" + uid().slice(0, 8);

        state.presets.push({ id, name, annualReturnPct: r, dividendPct: d, builtin: false });
        renderPresetList();
        recalcAndRender();
        saveStateDebounced();
        e.target.reset();
    });

    dlg.addEventListener("click", (e) => {
      if (e.target === dlg) dlg.close();
    });
}

/** =============================
 *  Events UI
 *  ============================= */
function renderEventList() {
  const wrap = $("eventList");
  wrap.innerHTML = "";

  const sorted = [...state.events].sort((a,b) => a.age - b.age);
  if (sorted.length === 0) {
    wrap.innerHTML = `<div class="text-[11px] text-slate-500 dark:text-slate-400">이벤트가 없습니다. “이벤트 추가”를 클릭하세요.</div>`;
    return;
  }

  for (const ev of sorted) {
    let border, subtitle, pill;

    switch (ev.type) {
        case 'portfolio':
            const preset = state.presets.find(p => p.id === ev.presetId);
            border = "border-purple-500";
            subtitle = `전략: ${preset ? preset.name : '알 수 없음'}, 비중: ${ev.weight}`;
            pill = `<span class="px-2 py-0.5 bg-purple-500 text-white text-[10px] font-bold rounded-full uppercase">포트폴리오</span>`;
            break;
        case 'monthly':
            border = "border-primary";
            subtitle = `월 납입액 ${fmtMoney(ev.amount)}으로 변경`;
            pill = `<span class="px-2 py-0.5 bg-primary text-white text-[10px] font-bold rounded-full uppercase">월납입</span>`;
            break;
        case 'lump':
            subtitle = `일시불 입금 ${ev.amount >= 0 ? "+" : ""}${fmtMoney(ev.amount)}`;
            pill = `<span class="px-2 py-0.5 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-[10px] font-bold rounded-full uppercase">일시불</span>`;
            break;
        case 'pension':
            border = "border-emerald-400";
            subtitle = `연금 수령 시작: 매월 ${fmtMoney(ev.amount)} (인출)`;
            pill = `<span class="px-2 py-0.5 bg-emerald-500 text-white text-[10px] font-bold rounded-full uppercase">연금</span>`;
            break;
        default: 
            subtitle = "알 수 없는 이벤트";
            pill = "";
    }

    const node = document.createElement("div");
    node.className = `p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border-l-4 ${border} relative`;
    node.innerHTML = `
      <div class="flex justify-between items-start gap-2">
        <div class="min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <p class="text-xs font-bold text-slate-900 dark:text-slate-100">${ev.age}세</p>
            ${pill}
          </div>
          <p class="text-[11px] text-slate-500 mt-0.5">${subtitle}</p>
        </div>
        <button class="text-slate-400 hover:text-red-500 transition-colors shrink-0" data-del="${ev.id}" title="삭제">
          <span class="material-symbols-outlined text-sm">delete</span>
        </button>
      </div>
    `;
    wrap.appendChild(node);
  }

  wrap.querySelectorAll("[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-del");
      state.events = state.events.filter(e => e.id !== id);
      renderEventList();
      recalcAndRender();
      saveStateDebounced();
    });
  });
}

function initEventDialog() {
  const dlg = $("eventDialog");
  const typeSelect = $("dlgType");
  const fieldsPortfolio = $('dlgFieldsPortfolio');
  const fieldsMonetary = $('dlgFieldsMonetary');
  const infoEl = $('dlgInfo');

  const updateDialogFields = () => {
    const type = typeSelect.value;
    fieldsPortfolio.classList.toggle('hidden', type !== 'portfolio');
    fieldsMonetary.classList.toggle('hidden', type === 'portfolio');

    let infoText = '';
    switch (type) {
        case 'portfolio': infoText = '해당 나이부터 포트폴리오 구성을 변경합니다. 같은 나이에 여러 개의 프리셋을 추가하여 비중을 조절할 수 있습니다.'; break;
        case 'monthly': infoText = '해당 나이부터 월 납입액을 새로 설정합니다.'; break;
        case 'lump': infoText = '해당 나이 시작 시점에 일시불로 입금 또는 출금됩니다.'; break;
        case 'pension': infoText = '해당 나이부터 매월 잔액에서 고정 금액을 인출합니다.'; break;
    }
    infoEl.textContent = infoText;
  };

  $("btnAddEvent").addEventListener("click", () => {
    const ageNow = state.inputs.ageNow;
    $("dlgAge").value = clamp(ageNow + 5, 0, 120);
    typeSelect.value = "portfolio";
    $("dlgLabel").value = "";
    $("dlgAmount").value = "";
    $('dlgWeight').value = 10;
    
    const presetSelect = $("dlgPresetId");
    presetSelect.innerHTML = state.presets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    
    updateDialogFields();
    dlg.showModal();
  });

  typeSelect.addEventListener('change', updateDialogFields);

  $("dlgSave").addEventListener("click", () => {
    const age = clamp(Number($("dlgAge").value || 0), 0, 120);
    const type = typeSelect.value;
    const id = uid();
    let newEvent = { id, age, type };

    if (type === 'portfolio') {
        newEvent.presetId = $('dlgPresetId').value;
        newEvent.weight = clamp(Number($('dlgWeight').value), 1, 10);
    } else {
        newEvent.amount = parseMoney($("dlgAmount").value);
        newEvent.label = $('dlgLabel').value.trim();
    }

    state.events.push(newEvent);
    renderEventList();
    recalcAndRender();
    saveStateDebounced();
  });

  dlg.addEventListener("click", (e) => {
    if (e.target === dlg) dlg.close();
  });
}

/** =============================
 *  Simulation Core
 *  ============================= */
function getActivePortfolio(age) {
    const portfolioEvents = state.events
        .filter(e => e.type === 'portfolio' && e.age <= age)
        .sort((a,b) => b.age - a.age);

    if (!portfolioEvents.length) return [];

    const latestAge = portfolioEvents[0].age;
    const activeEvents = portfolioEvents.filter(e => e.age === latestAge);
    
    const totalWeight = activeEvents.reduce((sum, e) => sum + e.weight, 0);
    if (totalWeight === 0) return [];

    return activeEvents.map(e => {
        const preset = state.presets.find(p => p.id === e.presetId);
        return {
            preset: preset || { annualReturnPct: 0, dividendPct: 0, name: 'Unknown' },
            weight: e.weight,
            percentage: e.weight / totalWeight
        };
    });
}

function simulate() {
  syncUiToStateFromInputs();
  const { ageNow, ageRetire, initialInvestment, monthlyContribution, autoZeroAfterRetire } = state.inputs;
  const endAge = state.maxAge;
  const startYear = state.startYear;

  const years = [];
  let portfolioState = getActivePortfolio(ageNow).map(p => ({ ...p, balance: initialInvestment * p.percentage }));

  for (let age = ageNow; age <= endAge; age++) {
    const year = startYear + (age - ageNow);
    let currentPortfolio = getActivePortfolio(age);

    // Rebalance if portfolio changed this year
    const portfolioChanged = JSON.stringify(currentPortfolio.map(p=>p.preset.id)) !== JSON.stringify(portfolioState.map(p=>p.preset.id));
    if (portfolioChanged) {
        const totalBalance = portfolioState.reduce((sum, p) => sum + p.balance, 0);
        portfolioState = currentPortfolio.map(p => ({ ...p, balance: totalBalance * p.percentage }));
    }

    // Contributions
    const baseMonthly = autoZeroAfterRetire && age >= ageRetire ? 0 : monthlyContribution;
    const activeMonthly = state.events
        .filter(e => e.type === "monthly" && e.age <= age)
        .sort((a,b) => b.age - a.age)[0]?.amount ?? baseMonthly;
    const lumpSum = state.events.filter(e => e.type === 'lump' && e.age === age).reduce((sum, e) => sum + e.amount, 0);

    // Pension
    const pensionMonthly = state.events.filter(e => e.type === 'pension' && e.age <= age).reduce((sum, e) => sum + e.amount, 0);

    let yearStartBalance = portfolioState.reduce((sum, p) => sum + p.balance, 0);
    if (lumpSum > 0) {
         portfolioState.forEach(p => p.balance += lumpSum * p.percentage);
    }

    let yContr = 0, yReturn = 0, yDiv = 0, yPension = 0;

    for (let m = 1; m <= 12; m++) {
      // Monthly contribution
      if(activeMonthly > 0) {
          portfolioState.forEach(p => p.balance += activeMonthly * p.percentage);
          yContr += activeMonthly;
      }
      
      // Growth and dividend
      portfolioState.forEach(p => {
          const r = p.balance * (p.preset.annualReturnPct / 100 / 12);
          const d = p.balance * (p.preset.dividendPct / 100 / 12);
          p.balance += r + d;
          yReturn += r;
          yDiv += d;
      });

      // Pension
      if (pensionMonthly > 0) {
          const totalBalanceBeforePension = portfolioState.reduce((sum, p) => sum + p.balance, 0);
          if (totalBalanceBeforePension > pensionMonthly) {
              portfolioState.forEach(p => {
                  const withdrawal = p.balance / totalBalanceBeforePension * pensionMonthly;
                  p.balance -= withdrawal;
              });
              yPension += pensionMonthly;
          }
      }
    }

    const endBalance = portfolioState.reduce((sum, p) => sum + p.balance, 0);

    years.push({
      year, age, 
      annualContribution: yContr, 
      returnEarned: yReturn, 
      dividends: yDiv, 
      pensionOut: yPension,
      endBalance,
      portfolio: currentPortfolio
    });
  }

  return { years, startYear, ageNow, endAge, retireAge };
}

/** =============================
 *  Render table + Chart
 *  ============================= */
function buildAnnualRow(y) {
  const portfolioDesc = y.portfolio.map(p => `${p.preset.name.substring(0,4)}:${(p.percentage*100).toFixed(0)}%`).join(' ');
  const badge = `<span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 text-xs font-semibold rounded-full">${portfolioDesc || '정의되지 않음'}</span>`;

  const highlight = y.age === state.inputs.ageRetire ? "bg-emerald-50/60 dark:bg-emerald-900/10" : "";

  return `
    <tr class="annual-row ${highlight} hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors group">
      <td class="px-6 py-4 font-bold text-slate-900 dark:text-slate-100">
        <div class="flex flex-col">
          <span>${y.year}</span>
          <span class="text-[10px] text-slate-400">${y.age}세${y.age === state.inputs.ageRetire ? " • 은퇴" : ""}</span>
        </div>
      </td>
      <td class="px-6 py-4 font-medium text-slate-600 dark:text-slate-400">${fmtMoney(y.annualContribution, true)}</td>
      <td class="px-6 py-4 font-bold text-primary">+${fmtMoney(y.returnEarned, true)}</td>
      <td class="px-6 py-4 font-medium text-slate-600 dark:text-slate-400">${fmtMoney(y.dividends, true)}</td>
      <td class="px-6 py-4 font-medium text-emerald-600 dark:text-emerald-300">-${fmtMoney(y.pensionOut, true)}</td>
      <td class="px-6 py-4 font-black">${fmtMoney(y.endBalance, true)}</td>
      <td class="px-6 py-4">${badge}</td>
    </tr>
  `;
}

function passesFilter(y) {
  if (!state.inputs.filterEnabled) return true;
  const from = Math.min(state.inputs.filterAgeFrom, state.inputs.filterAgeTo);
  const to = Math.max(state.inputs.filterAgeFrom, state.inputs.filterAgeTo);
  return y.age >= from && y.age <= to;
}

function renderAnnualTable(results) {
  const tbody = $("annualTbody");
  const filtered = results.years.filter(passesFilter);
  tbody.innerHTML = filtered.map(buildAnnualRow).join("");
}

function renderChart(results) {
  const filteredYears = results.years.filter(passesFilter);
  const labels = filteredYears.map(y => `${y.year}`);
  const datasets = {};
  
  // This is a simplified view for the chart. We calculate total principal and total returns.
  let cumulativePrincipal = state.inputs.initialInvestment;
  const principalData = [];
  const returnData = [];
  const endBalanceData = [];

  results.years.forEach(year => {
      cumulativePrincipal += year.annualContribution;
      if(passesFilter(year)){
          const principalComponent = Math.min(cumulativePrincipal, year.endBalance);
          const returnComponent = Math.max(0, year.endBalance - cumulativePrincipal);
          principalData.push(principalComponent);
          returnData.push(returnComponent);
          endBalanceData.push(year.endBalance);
      }
  });

  const ctx = $("balanceChart").getContext("2d");
  if (state.chart) state.chart.destroy();
  if (labels.length === 0) return;

  state.chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: '누적 투자원금', data: principalData, backgroundColor: '#2563eb' },
        { label: '누적 투자수익', data: returnData, backgroundColor: '#84cc16' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  });
}


/** =============================
 *  Observation
 *  ============================= */
function updateObservation(results) {
  const retireRow = results.years.find(y => y.age === state.inputs.ageRetire);
  const last = results.years[results.years.length - 1];

  let msg = ``;
  if (retireRow) {
    msg += `${state.inputs.ageRetire}세 (${retireRow.year}) 은퇴 시점에 예상 잔액은 ${fmtMoney(retireRow.endBalance, true)} 입니다. `;
  }
  if (last) {
    msg += `${state.maxAge}세 (${last.year})에 예상 잔액은 ${fmtMoney(last.endBalance, true)}가 될 수 있습니다.`;
  }
  $("observation").textContent = msg || '시뮬레이션 결과가 없습니다.';
}

/** =============================
 *  Recalc + Render
 *  ============================= */
function recalcAndRender() {
  const results = simulate();
  state.results = results;

  $("rangeLabel").textContent = `시작 연도 ${results.startYear} • ${results.ageNow}세 → ${results.endAge}세 • 은퇴 ${results.retireAge}세`;

  renderAnnualTable(results);
  updateObservation(results);

  if (!$("chartPanel").classList.contains("hidden")) {
    renderChart(results);
  }
}

/** =============================
 *  Inputs init
 *  ============================= */
function initInputs() {
  const inputsToWatch = ["ageNow", "ageRetire", "initialInvestment", "monthlyContribution", "autoZeroAfterRetire", "filterEnabled", "filterAgeFrom", "filterAgeTo"];
  inputsToWatch.forEach(id => {
      const el = $(id);
      el.addEventListener("input", () => { recalcAndRender(); saveStateDebounced(); });
      if(el.type !== 'text') el.addEventListener("change", () => { recalcAndRender(); saveStateDebounced(); });
      el.addEventListener("blur", () => {
          if(id === 'initialInvestment' || id === 'monthlyContribution') {
              const v = parseMoney($(id).value);
              $(id).value = v.toLocaleString();
          }
          syncUiToStateFromInputs(); 
          saveStateDebounced();
      });
  });

  $("btnToggleChart").addEventListener("click", () => {
    $("chartPanel").classList.toggle("hidden");
    if (!$("chartPanel").classList.contains("hidden")) {
      renderChart(state.results || simulate());
    }
  });
  
  $("btnResetAll").addEventListener("click", () => {
    if (confirm("저장된 모든 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
      resetSavedState();
      location.reload();
    }
  });
}

/** =============================
 *  Boot
 *  ============================= */
(function boot() {
  const saved = loadSavedState();
  applySnapshot(saved);
  syncStateToUi();
  initPresetManagement();
  initEventDialog();
  initInputs();
  recalcAndRender();
  saveStateDebounced();
})();
</script>
</body>
</html>