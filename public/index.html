<!DOCTYPE html>\n<html class="light" lang="ko">\n<head>\n  <meta charset="utf-8"/>\n  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>\n  <title>은퇴 시뮬레이터 (동적 포트폴리오)</title>\n\n  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>\n  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>\n  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap" rel="stylesheet"/>\n\n  <!-- Chart -->\n  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>\n  <script src="presets.js"></script>\n  <script src="events.js"></script>\n\n  <script id="tailwind-config">\n    tailwind.config = {\n      darkMode: "class",\n      theme: {\n        extend: {\n          colors: {\n            "primary": "#2563eb",\n            "secondary": "#1e40af",\n            "background-light": "#f8fafc",\n            "background-dark": "#0f172a",\n          },\n          fontFamily: { "display": ["Manrope", "sans-serif"] },\n          borderRadius: {\n            "DEFAULT": "0.375rem",\n            "lg": "0.5rem",\n            "xl": "0.75rem",\n            "full": "9999px"\n          },\n        },\n      },\n    }\n  </script>\n\n  <style type="text/tailwindcss">\n    @layer base { body { font-family: 'Manrope', sans-serif; } }\n    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 8px; }\n    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }\n    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }\n    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #2563eb; }\n    .table-scroll-area { max-height: 700px; overflow-y: auto; }\n    .row-chevron { transition: transform .15s ease; }\n    .row-open .row-chevron { transform: rotate(90deg); }\n    dialog::backdrop { background: rgba(0,0,0,.35); }\n  </style>\n</head>\n\n<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen font-display">\n<main class="max-w-[1440px] mx-auto px-6 lg:px-10 py-10">\n\n  <!-- Header -->\n  <div class="mb-8 flex items-center justify-between">\n    <div>\n      <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-slate-100">\n        은퇴 <span class="text-primary">시뮬레이터</span>\n      </h1>\n      <p class="text-slate-500 text-sm mt-1">동적 포트폴리오 • 이벤트 기반 • 영구 저장</p>\n    </div>\n    <div class="flex items-center gap-4">\n      <div class="text-right hidden sm:block">\n        <p class="text-xs font-bold text-slate-900 dark:text-slate-100 leading-none">로컬 프로필</p>\n        <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">브라우저에 저장됨</p>\n      </div>\n      <div class="size-10 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border-2 border-primary/20 flex items-center justify-center">\n        <span class="material-symbols-outlined text-slate-500 dark:text-slate-200">person</span>\n      </div>\n    </div>\n  </div>\n\n  <div class="flex flex-col lg:flex-row gap-8">\n\n    <!-- Left -->\n    <aside class="w-full lg:w-[440px] flex flex-col gap-6">\n\n      <!-- Config -->\n      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">\n        <div class="flex items-center justify-between mb-6">\n          <h2 class="text-lg font-bold flex items-center gap-2">\n            <span class="material-symbols-outlined text-primary">tune</span>\n            기본 설정\n          </h2>\n          <button id="btnResetAll" class="px-3 py-2 rounded-lg text-xs font-bold bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-200 hover:bg-red-100 dark:hover:bg-red-900/30">\n            저장된 데이터 초기화\n          </button>\n        </div>\n\n        <div class="space-y-4">\n          <div class="grid grid-cols-2 gap-4">\n            <div class="space-y-1.5">\n              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">현재 나이</label>\n              <input id="ageNow" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"\n                     type="number" min="0" max="120" value="30"/>\n            </div>\n            <div class="space-y-1.5">\n              <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">은퇴 연령</label>\n              <input id="ageRetire" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"\n                     type="number" min="0" max="120" value="65"/>\n            </div>\n          </div>\n\n          <div class="space-y-1.5">\n            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">초기 투자액 (₩)</label>\n            <input id="initialInvestment" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"\n                   type="text" value="50,000"/>\n          </div>\n\n          <div class="space-y-1.5">\n            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">월 납입액 (₩)</label>\n            <input id="monthlyContribution" class="w-full bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-lg py-2.5 px-4 focus:ring-primary focus:border-primary text-sm font-semibold"\n                   type="text" value="2,000"/>\n          </div>\n\n          <!-- Retirement auto switch -->\n          <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-3">\n            <div>\n              <p class="text-xs font-bold">은퇴 후 납입액 자동 0으로 설정</p>\n              <p class="text-[11px] text-slate-500 dark:text-slate-400">은퇴 연령부터 월 납입액이 0이 됩니다</p>\n            </div>\n            <label class="inline-flex items-center cursor-pointer">\n              <input id="autoZeroAfterRetire" type="checkbox" class="sr-only peer">\n              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-600 peer-checked:bg-primary relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      <!-- Events -->\n      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">\n        <div class="flex items-center justify-between mb-4">\n          <h2 class="text-lg font-bold flex items-center gap-2">\n            <span class="material-symbols-outlined text-primary">event_note</span>\n            시나리오 이벤트\n          </h2>\n          <button id="btnAddEvent" class="flex items-center gap-1 text-[11px] font-bold uppercase tracking-wider text-primary hover:text-primary/80 transition-colors">\n            <span class="material-symbols-outlined text-sm">add_circle</span> 이벤트 추가\n          </button>\n        </div>\n\n        <div id="eventList" class="space-y-3"></div>\n\n        <div class="mt-4 text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed">\n          지원 항목: <span class="font-semibold">포트폴리오 변경</span>,\n          <span class="font-semibold">월 납입액 변경</span>, <span class="font-semibold">일시불</span>,\n          <span class="font-semibold">연금(월 지급)</span>.\n        </div>\n         <button id="btnAddPreset" class="mt-4 w-full flex items-center justify-center gap-1 text-xs font-bold uppercase tracking-wider text-primary hover:text-primary/80 transition-colors border border-primary/50 rounded-lg py-2">\n            <span class="material-symbols-outlined text-sm">add_circle</span> 투자 프리셋 관리\n          </button>\n      </div>\n\n      <!-- Filter -->\n      <div class="bg-white dark:bg-slate-900/50 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">\n        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">\n          <span class="material-symbols-outlined text-primary">filter_alt</span>\n          표 필터 (나이 범위)\n        </h2>\n\n        <div class="grid grid-cols-2 gap-3">\n          <label class="block">\n            <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">시작 나이</span>\n            <input id="filterAgeFrom" type="number" min="0" max="120"\n                   class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"\n                   value="30"/>\n          </label>\n          <label class="block">\n            <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">종료 나이</span>\n            <input id="filterAgeTo" type="number" min="0" max="120"\n                   class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"\n                   value="100"/>\n          </label>\n        </div>\n\n        <div class="mt-3 flex items-center justify-between bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-3">\n          <div>\n            <p class="text-xs font-bold">필터 활성화</p>\n            <p class="text-[11px] text-slate-500 dark:text-slate-400">선택한 나이 범위의 연도만 표시</p>\n          </div>\n          <label class="inline-flex items-center cursor-pointer">\n            <input id="filterEnabled" type="checkbox" class="sr-only peer">\n              <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/30 rounded-full peer dark:bg-slate-600 peer-checked:bg-primary relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5"></div>\n            </label>\n        </div>\n      </div>\n\n    </aside>\n\n    <!-- Right -->\n    <section class="flex-1 flex flex-col gap-6">\n\n      <!-- Table Card -->\n      <div class="bg-white dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col h-full overflow-hidden">\n        <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-900 z-10">\n          <div>\n            <h2 class="text-lg font-bold">연간 성장 예측</h2>\n            <p id="rangeLabel" class="text-xs text-slate-500 mt-0.5">예상 분석</p>\n          </div>\n          <div class="flex gap-2 items-center">\n            <button id="btnToggleChart" class="size-10 flex items-center justify-center bg-primary text-white rounded-lg shadow-lg shadow-primary/20 hover:bg-secondary transition-all hover:scale-105 active:scale-95 group" title="차트 보기">\n              <span class="material-symbols-outlined">bar_chart</span>\n            </button>\n          </div>\n        </div>\n\n        <!-- Chart Panel -->\n        <div id="chartPanel" class="hidden border-b border-slate-100 dark:border-slate-800 bg-slate-50/60 dark:bg-slate-900/40 p-4">\n          <div class="flex items-center justify-between mb-2">\n            <p class="text-xs font-bold uppercase tracking-wider text-slate-500">자산 구성</p>\n            <p class="text-[11px] text-slate-500 dark:text-slate-400">연도별 누적 투자원금 및 투자수익</p>\n          </div>\n          <div class="bg-white dark:bg-slate-950 rounded-xl border border-slate-200 dark:border-slate-800 p-3">\n            <canvas id="balanceChart" height="360"></canvas>\n          </div>\n        </div>\n\n        <div class="table-scroll-area custom-scrollbar overflow-x-auto">\n          <table class="w-full text-left text-sm">\n            <thead class="sticky top-0 bg-slate-50 dark:bg-slate-800 z-10 shadow-sm">\n              <tr class="text-slate-500 font-bold uppercase text-[11px] tracking-wider">\n                <th class="px-6 py-4">연도 / 나이</th>\n                <th class="px-6 py-4">연간 납입액</th>\n                <th class="px-6 py-4">평가 수익</th>\n                <th class="px-6 py-4">배당금</th>\n                <th class="px-6 py-4">연금 인출</th>\n                <th class="px-6 py-4">기말 잔액</th>\n                <th class="px-6 py-4">포트폴리오</th>\n              </tr>\n            </thead>\n            <tbody id="annualTbody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>\n          </table>\n        </div>\n      </div>\n\n      <!-- Observation -->\n      <div class="bg-primary/5 border border-primary/20 p-5 rounded-xl flex items-start gap-4">\n        <div class="bg-primary text-white p-2.5 rounded-lg shadow-sm">\n          <span class="material-symbols-outlined block">lightbulb</span>\n        </div>\n        <div>\n          <h4 class="text-sm font-bold text-slate-900 dark:text-white">스마트 요약</h4>\n          <p id="observation" class="text-xs text-slate-600 dark:text-slate-400 mt-1 leading-relaxed">\n            왼쪽 항목들을 수정하여 은퇴 계획을 시뮬레이션 해보세요.\n          </p>\n        </div>\n      </div>\n\n    </section>\n  </div>\n</main>\n\n<footer class="mt-12 py-10 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950">\n  <div class="max-w-[1440px] mx-auto px-10 flex flex-col md:flex-row items-center justify-between gap-6 text-slate-500 text-[11px] font-medium">\n    <div class="flex items-center gap-4">\n      <span class="material-symbols-outlined text-primary text-sm">verified_user</span>\n      <p>© 2024 은퇴계획 Pro. 데이터는 브라우저에 저장됩니다. 본 시뮬레이션은 투자 자문이 아닙니다.</p>\n    </div>\n  </div>\n</footer>\n\n<!-- Add Event Dialog -->\n<dialog id="eventDialog" class="rounded-xl p-0 w-[92vw] max-w-md bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 shadow-2xl">\n  <form method="dialog" class="p-5">\n    <div class="flex items-center justify-between mb-3">\n      <h3 class="text-sm font-extrabold">시나리오 이벤트 추가</h3>\n      <button value="cancel" class="text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">\n        <span class="material-symbols-outlined">close</span>\n      </button>\n    </div>\n\n    <div class="space-y-3">\n      <div class="grid grid-cols-2 gap-3">\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">나이</span>\n          <input id="dlgAge" type="number" min="0" max="120"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">종류</span>\n          <select id="dlgType" class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold">\n            <option value="portfolio">포트폴리오 변경</option>\n            <option value="monthly">월 납입액 변경</option>\n            <option value="lump">일시불 입금</option>\n            <option value="pension">연금 수령 (월)</option>\n          </select>\n        </label>\n      </div>\n\n      <div id="dlgFieldsPortfolio" class="space-y-3 pt-2">\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">투자 프리셋</span>\n          <select id="dlgPresetId" class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"></select>\n        </label>\n         <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">비중 (1-10)</span>\n          <input id="dlgWeight" type="number" min="1" max="10" value="10"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n      </div>\n\n      <div id="dlgFieldsMonetary" class="hidden space-y-3 pt-2">\n         <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">라벨</span>\n          <input id="dlgLabel" type="text" placeholder="예: 승진, 아파트 매매"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">금액 (₩)</span>\n          <input id="dlgAmount" type="text" placeholder="예: 1500000"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n      </div>\n\n      <div id="dlgInfo" class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed pt-1"></div>\n    </div>\n\n    <div class="mt-5 flex gap-2 justify-end">\n      <button value="cancel" class="px-4 py-2 rounded-lg text-xs font-bold bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700">취소</button>\n      <button id="dlgSave" value="ok" class="px-4 py-2 rounded-lg text-xs font-bold bg-primary text-white hover:bg-secondary">이벤트 추가</button>\n    </div>\n  </form>\n</dialog>\n\n<!-- Add Preset Dialog -->\n<dialog id="presetDialog" class="rounded-xl p-0 w-[92vw] max-w-md bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 shadow-2xl">\n  <div class="p-5">\n    <div class="flex items-center justify-between mb-4">\n      <h3 class="text-sm font-extrabold">투자 프리셋 관리</h3>\n       <form method="dialog">\n        <button value="cancel" class="text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">\n          <span class="material-symbols-outlined">close</span>\n        </button>\n      </form>\n    </div>\n    \n    <div id="presetList" class="space-y-2 mb-4"></div>\n\n    <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 pt-4 border-t border-slate-200 dark:border-slate-800">새 프리셋 추가</h4>\n    <form id="newPresetForm" class="space-y-3">\n      <label class="block">\n        <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">프리셋 이름</span>\n        <input id="dlgPresetName" type="text" placeholder="예: 성장주 포트폴리오"\n               class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n      </label>\n\n      <div class="grid grid-cols-2 gap-3">\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">연간 수익률 (%)</span>\n          <input id="dlgPresetReturn" type="text" value="9.0"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n        <label class="block">\n          <span class="text-[11px] font-bold uppercase tracking-wider text-slate-500">배당 수익률 (%)</span>\n          <input id="dlgPresetDiv" type="text" value="2.0"\n                 class="mt-1 w-full bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm font-semibold"/>\n        </label>\n      </div>\n      <button id="dlgPresetSave" type="submit" class="w-full px-4 py-2 rounded-lg text-xs font-bold bg-primary text-white hover:bg-secondary">새 프리셋 저장</button>\n    </form>\n  </div>\n</dialog>\n\n<script>\n/** =============================\n *  Persistence (localStorage)\n *  ============================= */\nconst STORAGE_KEY = "retire_sim_v2_dynamic_portfolio";\n\nfunction safeJsonParse(s) {\n  try { return JSON.parse(s); } catch { return null; }\n}\n\nfunction loadSavedState() {\n  const raw = localStorage.getItem(STORAGE_KEY);\n  const data = safeJsonParse(raw);\n  return data && typeof data === "object" ? data : null;\n}\n\nfunction saveStateDebounced() {\n  clearTimeout(saveStateDebounced._t);\n  saveStateDebounced._t = setTimeout(() => {\n    const snapshot = buildSnapshot();\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));\n  }, 150);\n}\n\nfunction resetSavedState() {\n  localStorage.removeItem(STORAGE_KEY);\n}\n\n/** -----------------------------\n *  Utilities\n *  ----------------------------- */\nconst $ = (id) => document.getElementById(id);\n\nfunction parseMoney(input) {\n  if (typeof input === "number") return input;\n  const s = String(input || "").replace(/[^0-9.-]/g, "");\n  const n = Number(s);\n  return Number.isFinite(n) ? n : 0;\n}\n\nfunction fmtMoney(n, compact = false) {\n    const num = Number(n);\n    if (!Number.isFinite(num)) return "0원";\n\n    if (compact) {\n        if (Math.abs(num) >= 100000000) {\n            return `${parseFloat((num / 100000000).toFixed(2))}억`;\n        } else if (Math.abs(num) >= 10000) {\n            return `${parseFloat((num / 10000).toFixed(0))}만`;\n        }\n    }\n    return `${Math.round(num).toLocaleString()}원`;\n}\n\nfunction clamp(n, min, max) {\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction parsePct(s) {\n  const v = Number(parseFloat(String(s || "").replace(/[^0-9.%]/g, "")));\n  return Number.isFinite(v) ? v : 0;\n}\n\nfunction uid() {\n  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);\n}\n\n/** =============================\n *  State\n *  ============================= */\nconst state = {\n  startYear: new Date().getFullYear(),\n  maxAge: 100,\n\n  presets: [...defaultPresets],\n\n  inputs: {\n    ageNow: 30,\n    ageRetire: 65,\n    initialInvestment: 50000000,\n    monthlyContribution: 2000000,\n    autoZeroAfterRetire: true,\n    filterEnabled: false,\n    filterAgeFrom: 30,\n    filterAgeTo: 100\n  },\n\n  events: [],\n  results: null,\n  chart: null\n};\n\n/** =============================\n *  Snapshot / Restore\n *  ============================= */\nfunction buildSnapshot() {\n  return {\n    version: 2,\n    presets: state.presets.map(p => ({ ...p })),\n    inputs: { ...state.inputs },\n    events: state.events.map(e => ({ ...e })),\n    savedAt: new Date().toISOString()\n  };\n}\n\nfunction applySnapshot(snap) {\n  if (!snap || snap.version !== 2) {\n    state.events = defaultEvents.map(e => ({ ...e, id: uid() }));\n    return;\n  }\n\n  // Presets\n  const builtins = [...defaultPresets];\n  const userPresets = Array.isArray(snap.presets)\n    ? snap.presets.filter(p => p && !p.builtin && p.id && p.name)\n    : [];\n  state.presets = [...builtins, ...userPresets];\n\n  // Inputs\n  if (snap.inputs && typeof snap.inputs === 'object') {\n     Object.assign(state.inputs, snap.inputs);\n  }\n\n  // Events\n  if (Array.isArray(snap.events) && snap.events.length > 0) {\n    state.events = snap.events\n      .filter(e => e && e.type && e.age != null)\n      .map(e => ({ ...e, id: e.id || uid() }));\n  } else {\n    state.events = defaultEvents.map(e => ({ ...e, id: uid() }));\n  }\n}\n\n/** =============================\n *  UI binding helpers\n *  ============================= */\nfunction syncStateToUi() {\n  $("ageNow").value = state.inputs.ageNow;\n  $("ageRetire").value = state.inputs.ageRetire;\n  $("initialInvestment").value = state.inputs.initialInvestment.toLocaleString();\n  $("monthlyContribution").value = state.inputs.monthlyContribution.toLocaleString();\n  $("autoZeroAfterRetire").checked = state.inputs.autoZeroAfterRetire;\n\n  $("filterEnabled").checked = state.inputs.filterEnabled;\n  $("filterAgeFrom").value = state.inputs.filterAgeFrom;\n  $("filterAgeTo").value = state.inputs.filterAgeTo;\n\n  renderEventList();\n}\n\nfunction syncUiToStateFromInputs() {\n  state.inputs.ageNow = clamp(Number($("ageNow").value || 0), 0, 120);\n  state.inputs.ageRetire = clamp(Number($("ageRetire").value || 0), 0, 120);\n  state.inputs.initialInvestment = parseMoney($("initialInvestment").value);\n  state.inputs.monthlyContribution = parseMoney($("monthlyContribution").value);\n  state.inputs.autoZeroAfterRetire = $("autoZeroAfterRetire").checked;\n\n  state.inputs.filterEnabled = $("filterEnabled").checked;\n  state.inputs.filterAgeFrom = clamp(Number($("filterAgeFrom").value || 0), 0, 120);\n  state.inputs.filterAgeTo = clamp(Number($("filterAgeTo").value || 0), 0, 120);\n}\n\n\n/** =============================\n *  Presets Management\n *  ============================= */\nfunction renderPresetList() {\n  const listEl = $("presetList");\n  listEl.innerHTML = "";\n  state.presets.forEach(p => {\n    const item = document.createElement("div");\n    item.className = "flex items-center justify-between gap-2 text-sm p-2 rounded-lg bg-slate-50 dark:bg-slate-800/50";\n    item.innerHTML = `\n      <div class="font-bold">${p.name} ${p.builtin ? '(기본)' : ''}</div>\n      <div class="text-xs text-slate-500">수익 ${p.annualReturnPct}% / 배당 ${p.dividendPct}%</div>\n      ${!p.builtin ? `<button data-del-preset="${p.id}" class="text-red-500 hover:text-red-400"><span class="material-symbols-outlined text-sm">delete</span></button>` : ''}\n    `;\n    listEl.appendChild(item);\n  });\n\n  listEl.querySelectorAll("[data-del-preset]").forEach(btn => {\n      btn.addEventListener("click", (e) => {\n          const id = e.currentTarget.getAttribute("data-del-preset");\n          state.presets = state.presets.filter(p => p.id !== id);\n          renderPresetList();\n          recalcAndRender();\n          saveStateDebounced();\n      });\n  });\n}\n\nfunction initPresetManagement() {\n    const dlg = $('presetDialog');\n    $('btnAddPreset').addEventListener('click', () => {\n        renderPresetList();\n        $('newPresetForm').reset();\n        dlg.showModal();\n    });\n\n    $('newPresetForm').addEventListener('submit', (e) => {\n        e.preventDefault();\n        const name = ($("dlgPresetName").value || "").trim();\n        const r = parsePct($("dlgPresetReturn").value);\n        const d = parsePct($("dlgPresetDiv").value);\n\n        if (!name) return;\n        const id = "u_" + uid().slice(0, 8);\n\n        state.presets.push({ id, name, annualReturnPct: r, dividendPct: d, builtin: false });\n        renderPresetList();\n        recalcAndRender();\n        saveStateDebounced();\n        e.target.reset();\n    });\n\n    dlg.addEventListener("click", (e) => {\n      if (e.target === dlg) dlg.close();\n    });\n}\n\n/** =============================\n *  Events UI\n *  ============================= */\nfunction renderEventList() {\n  const wrap = $("eventList");\n  wrap.innerHTML = "";\n\n  const sorted = [...state.events].sort((a,b) => a.age - b.age);\n  if (sorted.length === 0) {\n    wrap.innerHTML = `<div class="text-[11px] text-slate-500 dark:text-slate-400">이벤트가 없습니다. “이벤트 추가”를 클릭하세요.</div>`;\n    return;\n  }\n\n  for (const ev of sorted) {\n    let border, subtitle, pill;\n\n    switch (ev.type) {\n        case 'portfolio':\n            const preset = state.presets.find(p => p.id === ev.presetId);\n            border = "border-purple-500";\n            subtitle = `전략: ${preset ? preset.name : '알 수 없음'}, 비중: ${ev.weight}`;
            pill = `<span class="px-2 py-0.5 bg-purple-500 text-white text-[10px] font-bold rounded-full uppercase">포트폴리오</span>`;\n            break;\n        case 'monthly':\n            border = "border-primary";\n            subtitle = `월 납입액 ${fmtMoney(ev.amount)}으로 변경`;\n            pill = `<span class="px-2 py-0.5 bg-primary text-white text-[10px] font-bold rounded-full uppercase">월납입</span>`;\n            break;\n        case 'lump':\n            subtitle = `일시불 입금 ${ev.amount >= 0 ? "+" : ""}${fmtMoney(ev.amount)}`;\n            pill = `<span class="px-2 py-0.5 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-200 text-[10px] font-bold rounded-full uppercase">일시불</span>`;\n            break;\n        case 'pension':\n            border = "border-emerald-400";\n            subtitle = `연금 수령 시작: 매월 ${fmtMoney(ev.amount)} (인출)`;\n            pill = `<span class="px-2 py-0.5 bg-emerald-500 text-white text-[10px] font-bold rounded-full uppercase">연금</span>`;\n            break;\n        default: \n            subtitle = "알 수 없는 이벤트";\n            pill = "";\n    }\n\n    const node = document.createElement("div");\n    node.className = `p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border-l-4 ${border} relative`;\n    node.innerHTML = `\n      <div class="flex justify-between items-start gap-2">\n        <div class="min-w-0">\n          <div class="flex items-center gap-2 flex-wrap">\n            <p class="text-xs font-bold text-slate-900 dark:text-slate-100">${ev.age}세</p>\n            ${pill}\n          </div>\n          <p class="text-[11px] text-slate-500 mt-0.5">${subtitle}</p>\n        </div>\n        <button class="text-slate-400 hover:text-red-500 transition-colors shrink-0" data-del="${ev.id}" title="삭제">\n          <span class="material-symbols-outlined text-sm">delete</span>\n        </button>\n      </div>\n    `;\n    wrap.appendChild(node);\n  }\n\n  wrap.querySelectorAll("[data-del]").forEach(btn => {\n    btn.addEventListener("click", () => {\n      const id = btn.getAttribute("data-del");\n      state.events = state.events.filter(e => e.id !== id);\n      renderEventList();\n      recalcAndRender();\n      saveStateDebounced();\n    });\n  });\n}\n\nfunction initEventDialog() {\n  const dlg = $("eventDialog");\n  const typeSelect = $("dlgType");\n  const fieldsPortfolio = $('dlgFieldsPortfolio');\n  const fieldsMonetary = $('dlgFieldsMonetary');\n  const infoEl = $('dlgInfo');\n\n  const updateDialogFields = () => {\n    const type = typeSelect.value;\n    fieldsPortfolio.classList.toggle('hidden', type !== 'portfolio');\n    fieldsMonetary.classList.toggle('hidden', type === 'portfolio');\n\n    let infoText = '';\n    switch (type) {\n        case 'portfolio': infoText = '해당 나이부터 포트폴리오 구성을 변경합니다. 같은 나이에 여러 개의 프리셋을 추가하여 비중을 조절할 수 있습니다.'; break;\n        case 'monthly': infoText = '해당 나이부터 월 납입액을 새로 설정합니다.'; break;\n        case 'lump': infoText = '해당 나이 시작 시점에 일시불로 입금 또는 출금됩니다.'; break;\n        case 'pension': infoText = '해당 나이부터 매월 잔액에서 고정 금액을 인출합니다.'; break;\n    }\n    infoEl.textContent = infoText;\n  };\n\n  $("btnAddEvent").addEventListener("click", () => {\n    const ageNow = state.inputs.ageNow;\n    $("dlgAge").value = clamp(ageNow + 5, 0, 120);\n    typeSelect.value = "portfolio";\n    $("dlgLabel").value = "";\n    $("dlgAmount").value = "";\n    $('dlgWeight').value = 10;\n    \n    const presetSelect = $("dlgPresetId");\n    presetSelect.innerHTML = state.presets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');\n    \n    updateDialogFields();\n    dlg.showModal();\n  });\n\n  typeSelect.addEventListener('change', updateDialogFields);\n\n  $("dlgSave").addEventListener("click", () => {\n    const age = clamp(Number($("dlgAge").value || 0), 0, 120);\n    const type = typeSelect.value;\n    const id = uid();\n    let newEvent = { id, age, type };\n\n    if (type === 'portfolio') {\n        newEvent.presetId = $('dlgPresetId').value;\n        newEvent.weight = clamp(Number($('dlgWeight').value), 1, 10);\n    } else {\n        newEvent.amount = parseMoney($("dlgAmount").value);\n        newEvent.label = $('dlgLabel').value.trim();\n    }\n\n    state.events.push(newEvent);\n    renderEventList();\n    recalcAndRender();\n    saveStateDebounced();\n  });\n\n  dlg.addEventListener("click", (e) => {\n    if (e.target === dlg) dlg.close();\n  });\n}\n\n/** =============================\n *  Simulation Core\n *  ============================= */\nfunction getActivePortfolio(age) {\n    const portfolioEvents = state.events\n        .filter(e => e.type === 'portfolio' && e.age <= age)\n        .sort((a,b) => b.age - a.age);\n\n    if (!portfolioEvents.length) {\n        const firstPreset = state.presets[0];\n        if (!firstPreset) return [];\n        return [{
            preset: firstPreset,\n            weight: 10,\n            percentage: 1\n        }];\n    }\n\n    const latestAge = portfolioEvents[0].age;\n    const activeEvents = portfolioEvents.filter(e => e.age === latestAge);\n    \n    const totalWeight = activeEvents.reduce((sum, e) => sum + e.weight, 0);\n    if (totalWeight === 0) return [];\n\n    return activeEvents.map(e => {\n        const preset = state.presets.find(p => p.id === e.presetId);\n        return {\n            preset: preset || { annualReturnPct: 0, dividendPct: 0, name: 'Unknown' },\n            weight: e.weight,\n            percentage: e.weight / totalWeight\n        };\n    });\n}\n\nfunction getPortfolioSignature(portfolio) {\n    if (!portfolio || portfolio.length === 0) return '';\n    return portfolio.map(p => `${p.preset.id}:${p.percentage.toFixed(4)}`).sort().join('|');\n}\n\nfunction simulate() {\n  syncUiToStateFromInputs();\n  const { ageNow, ageRetire, initialInvestment, monthlyContribution, autoZeroAfterRetire } = state.inputs;\n  const endAge = state.maxAge;\n  const startYear = state.startYear;\n\n  const years = [];\n  \n  let firstPortfolio = getActivePortfolio(ageNow);\n  let portfolioState = firstPortfolio.map(p => ({ ...p, balance: initialInvestment * p.percentage }));\n  let lastPortfolioSignature = getPortfolioSignature(firstPortfolio);\n
  for (let age = ageNow; age <= endAge; age++) {\n    const year = startYear + (age - ageNow);\n    let currentPortfolioConfig = getActivePortfolio(age);\n    const currentPortfolioSignature = getPortfolioSignature(currentPortfolioConfig);\n\n    if (currentPortfolioSignature !== lastPortfolioSignature) {\n        const totalBalance = portfolioState.reduce((sum, p) => sum + p.balance, 0);\n        portfolioState = currentPortfolioConfig.map(p => ({ ...p, balance: totalBalance * p.percentage }));\n        lastPortfolioSignature = currentPortfolioSignature;\n    }\n\n    const baseMonthly = autoZeroAfterRetire && age >= ageRetire ? 0 : monthlyContribution;\n    const activeMonthly = state.events\n        .filter(e => e.type === "monthly" && e.age <= age)\n        .sort((a,b) => b.age - a.age)[0]?.amount ?? baseMonthly;\n    const lumpSum = state.events.filter(e => e.type === 'lump' && e.age === age).reduce((sum, e) => sum + e.amount, 0);\n    const pensionMonthly = state.events.filter(e => e.type === 'pension' && e.age <= age).reduce((sum, e) => sum + e.amount, 0);\n\n    if (lumpSum !== 0) {\n         const totalBalanceBeforeLump = portfolioState.reduce((sum, p) => sum + p.balance, 0);\n         if (totalBalanceBeforeLump > 0) { \n            portfolioState.forEach(p => p.balance += lumpSum * (p.balance / totalBalanceBeforeLump));\n         } else if (portfolioState.length > 0) {\n            portfolioState.forEach(p => p.balance += lumpSum * p.percentage);\n         }\n    }\n
    let yContr = 0, yReturn = 0, yDiv = 0, yPension = 0;\n
    for (let m = 1; m <= 12; m++) {\n      if(activeMonthly > 0) {\n          portfolioState.forEach(p => p.balance += activeMonthly * p.percentage);\n          yContr += activeMonthly;\n      }\n      \n      portfolioState.forEach(p => {\n          const r = p.balance * (p.preset.annualReturnPct / 100 / 12);\n          const d = p.balance * (p.preset.dividendPct / 100 / 12);\n          p.balance += r + d;\n          yReturn += r;\n          yDiv += d;\n      });\n
      if (pensionMonthly > 0) {\n          const totalBalanceBeforePension = portfolioState.reduce((sum, p) => sum + p.balance, 0);\n          if (totalBalanceBeforePension > pensionMonthly) {\n              const fraction = pensionMonthly / totalBalanceBeforePension;\n              portfolioState.forEach(p => { p.balance -= p.balance * fraction; });\n              yPension += pensionMonthly;\n          } else { // Liquidate all\n              yPension += totalBalanceBeforePension;\n              portfolioState.forEach(p => { p.balance = 0; });\n          }\n      }\n    }\n
    const endBalance = portfolioState.reduce((sum, p) => sum + p.balance, 0);\n
    years.push({\n      year, age, \n      annualContribution: yContr, \n      returnEarned: yReturn, \n      dividends: yDiv, \n      pensionOut: yPension,\n      endBalance,\n      portfolio: currentPortfolioConfig\n    });\n  }\n\n  return { years, startYear, ageNow, endAge, retireAge };\n}\n\n/** =============================\n *  Render table + Chart\n *  ============================= */\nfunction buildAnnualRow(y) {\n  const portfolioDesc = y.portfolio.map(p => `${p.preset.name.substring(0,4)}:${(p.percentage*100).toFixed(0)}%`).join(' ');\n  const badge = `<span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 text-slate-500 text-xs font-semibold rounded-full">${portfolioDesc || '정의되지 않음'}</span>`;\n\n  const highlight = y.age === state.inputs.ageRetire ? "bg-emerald-50/60 dark:bg-emerald-900/10" : "";\n\n  return `\n    <tr class="annual-row ${highlight} hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors group">\n      <td class="px-6 py-4 font-bold text-slate-900 dark:text-slate-100">\n        <div class="flex flex-col">\n          <span>${y.year}</span>\n          <span class="text-[10px] text-slate-400">${y.age}세${y.age === state.inputs.ageRetire ? " • 은퇴" : ""}</span>\n        </div>\n      </td>\n      <td class="px-6 py-4 font-medium text-slate-600 dark:text-slate-400">${fmtMoney(y.annualContribution, true)}</td>\n      <td class="px-6 py-4 font-bold text-primary">+${fmtMoney(y.returnEarned, true)}</td>\n      <td class="px-6 py-4 font-medium text-slate-600 dark:text-slate-400">${fmtMoney(y.dividends, true)}</td>\n      <td class="px-6 py-4 font-medium text-emerald-600 dark:text-emerald-300">-${fmtMoney(y.pensionOut, true)}</td>\n      <td class="px-6 py-4 font-black">${fmtMoney(y.endBalance, true)}</td>\n      <td class="px-6 py-4">${badge}</td>\n    </tr>\n  `;\n}\n\nfunction passesFilter(y) {\n  if (!state.inputs.filterEnabled) return true;\n  const from = Math.min(state.inputs.filterAgeFrom, state.inputs.filterAgeTo);\n  const to = Math.max(state.inputs.filterAgeFrom, state.inputs.filterAgeTo);\n  return y.age >= from && y.age <= to;\n}\n\nfunction renderAnnualTable(results) {\n  const tbody = $("annualTbody");\n  const filtered = results.years.filter(passesFilter);\n  tbody.innerHTML = filtered.map(buildAnnualRow).join("");\n}\n\nfunction renderChart(results) {\n  const filteredYears = results.years.filter(passesFilter);\n  const labels = filteredYears.map(y => `${y.year}`);\n  const datasets = {};\n  \n  // This is a simplified view for the chart. We calculate total principal and total returns.\n  let cumulativePrincipal = state.inputs.initialInvestment;\n  const principalData = [];\n  const returnData = [];\n  const endBalanceData = [];\n\n  results.years.forEach(year => {\n      cumulativePrincipal += year.annualContribution;\n      if(passesFilter(year)){\n          const principalComponent = Math.min(cumulativePrincipal, year.endBalance);\n          const returnComponent = Math.max(0, year.endBalance - cumulativePrincipal);\n          principalData.push(principalComponent);\n          returnData.push(returnComponent);\n          endBalanceData.push(year.endBalance);\n      }\n  });\n\n  const ctx = $("balanceChart").getContext("2d");\n  if (state.chart) state.chart.destroy();\n  if (labels.length === 0) return;\n\n  state.chart = new Chart(ctx, {\n    type: 'bar',\n    data: {\n      labels,\n      datasets: [\n        { label: '누적 투자원금', data: principalData, backgroundColor: '#2563eb' },\n        { label: '누적 투자수익', data: returnData, backgroundColor: '#84cc16' }\n      ]\n    },\n    options: {\n      responsive: true, maintainAspectRatio: false,\n      plugins: { legend: { position: 'top' } },\n      scales: { x: { stacked: true }, y: { stacked: true } }\n    }\n  });\n}\n\n\n/** =============================\n *  Observation\n *  ============================= */\nfunction updateObservation(results) {\n  const retireRow = results.years.find(y => y.age === state.inputs.ageRetire);\n  const last = results.years[results.years.length - 1];\n\n  let msg = ``;\n  if (retireRow) {\n    msg += `${state.inputs.ageRetire}세 (${retireRow.year}) 은퇴 시점에 예상 잔액은 ${fmtMoney(retireRow.endBalance, true)} 입니다. `;
  }\n  if (last) {\n    msg += `${state.maxAge}세 (${last.year})에 예상 잔액은 ${fmtMoney(last.endBalance, true)}가 될 수 있습니다.`;\n  }\n  $("observation").textContent = msg || '시뮬레이션 결과가 없습니다.';\n}\n\n/** =============================\n *  Recalc + Render\n *  ============================= */\nfunction recalcAndRender() {\n  const results = simulate();\n  state.results = results;\n\n  $("rangeLabel").textContent = `시작 연도 ${results.startYear} • ${results.ageNow}세 → ${results.endAge}세 • 은퇴 ${results.retireAge}세`;\n\n  renderAnnualTable(results);\n  updateObservation(results);\n\n  if (!$("chartPanel").classList.contains("hidden")) {\n    renderChart(results);\n  }\n}\n\n/** =============================\n *  Inputs init\n *  ============================= */\nfunction initInputs() {\n  const inputsToWatch = ["ageNow", "ageRetire", "initialInvestment", "monthlyContribution", "autoZeroAfterRetire", "filterEnabled", "filterAgeFrom", "filterAgeTo"];\n  inputsToWatch.forEach(id => {\n      const el = $(id);\n      el.addEventListener("input", () => { recalcAndRender(); saveStateDebounced(); });\n      if(el.type !== 'text') el.addEventListener("change", () => { recalcAndRender(); saveStateDebounced(); });\n      el.addEventListener("blur", () => {\n          if(id === 'initialInvestment' || id === 'monthlyContribution') {\n              const v = parseMoney($(id).value);\n              $(id).value = v.toLocaleString();\n          }\n          syncUiToStateFromInputs(); \n          saveStateDebounced();\n      });\n  });\n\n  $("btnToggleChart").addEventListener("click", () => {\n    $("chartPanel").classList.toggle("hidden");\n    if (!$("chartPanel").classList.contains("hidden")) {\n      renderChart(state.results || simulate());\n    }\n  });\n  \n  $("btnResetAll").addEventListener("click", () => {\n    if (confirm("저장된 모든 데이터를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {\n      resetSavedState();\n      location.reload();\n    }\n  });\n}\n\n/** =============================\n *  Boot\n *  ============================= */\n(function boot() {\n  const saved = loadSavedState();\n  applySnapshot(saved);\n  syncStateToUi();\n  initPresetManagement();\n  initEventDialog();\n  initInputs();\n  recalcAndRender();\n  saveStateDebounced();\n})();\n</script>\n</body>\n</html>